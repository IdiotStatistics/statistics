\chapter{仮説検定の実践}
実際に利用されている仮説検定について説明する。
すでに$p$値の利用方法について否定的に批判している論文が多数でているので、何か付け加えることはなにもない。

%$p$値だけではなにも主張することができないのに、
%生物統計学ではいくらか主張可能であるということにしている点が
%ここではあえて間違いとみなされている方法も含めている。
%正しい仮説検定について説明してある論文は多い。
%生物の研究を行うさいの手順としても、手順には研究分野毎に差異があり、それら全てを網羅することは非常に困難である。


\section{仮説検定における手順}
仮説検定とは、仮説を採用するかを決定する方法である\footnote{すでに示したように、$p$値がある値を超たかどうかのみによって科学的な結論や政策の決定をおこなうべきではない}。
%数多くの研究で、科学的な検証がなされたことを示すために、仮説検定が利用されている。
%その手順は、データの出現頻度を予測するという方法論を十分に利用しきれていない\footnote{予測を一切考えないので、モデルという考えが存在しないように見える}。
帰無仮説の元、標本の統計量以上に偏った値が得られる確率($p$値)を計算する。
$p$値が$0.05$よりも小さいならば、対立仮説を採択し、$p>\alpha$ならば判断を保留する。
%Fisherが有意検定を提案した後に、Neyman-Pearsonが仮説検定を提案し、その後、それらを組み合わせた仮説検定が利用されることになった。
%科学的仮説検定では、データが統計的法則により予測可能であるかを示すため、モデルを構築した。
%仮説検定では、仮説を使たてる。
%モデルの母数に関する仮説のみを帰無仮説と定義し、帰無仮説で指定した母数ではないを対立仮説と呼ぶ。

仮説検定の枠組みでは、データが前提を満たさなければならないと考えられていることが多い\footnote{仮説検定を使う研究者にとって、モデルを使った予測であるということは意識されない。モデルの仮定ではなく、仮説検定をするための前提のことである}。
例えば、データは独立同一の分布関数から得られている\footnote{これを確かめる方法はあるのだろうか。言い換えるなら、現象が数学的分布関数により生じていることを確かめる必要があるとされることがある}。
これは、特定の分布関数にデータが従っていることを前提にし、前提が正しいならば、帰結も正しいと考えており、正しいデータを使わなければ仮説を検証できないと考えているからである\footnote{実際には、前提は検証できないのだが、仮説検定においては、できると決定されている}。%そのようなケースは実際の現象においては非常に稀であると考えられる。
ゆえに、データと想定した仮説の前提を満たしていることを注意深く検証しながら、仮説検定を利用することが求められている\footnote{科学的仮説検定では、現象を予測するためにモデルを使ったので、モデルの仮説をデータが満たさなくても良い}。
また、正規分布を仮定しているのであれば、データの分散と帰無仮説の分散が等しいなどである。
そのため、仮説検定を行う前に、いくつかの仮説検定を行い、これらの前提を確かめる。正規分布の仮定は、$Shapiro$検定を使う。その後、正規分布であれば、等分散検定などを行う。
これらの前段階の検定では、$p$値が設定した$\alpha$よりも小さければ、対立仮説を採択し、$p>\alpha$であれば、帰無仮説を採用する\footnote{検定により対立仮説や帰無仮説を採択することはできないが、仮説検定においてはできるという立場をとる。}\footnote{検定ではモデルを決定できない。仮説検定においてはそれができるということにして、仮説の論証がなされている。}\footnote{採択すると言い切ったが、前段階の検定においては、採択または棄却と判断してるといっておいた方が現状にあっている。}。
さらに、最終的な仮説検定においては、$p<\alpha$ならば帰無仮説を棄却し、$p>\alpha$ならば、判断を保留する
\footnote{仮説検定の手順は分野によって少しずつ異なるので、指導教員に手順を聞くことを勧める。留年したくないなら、魔術を信仰した方が良い。やれと言われたことをやらなければ論文は通らない。}
%\footnote{科学的仮説検定と仮説検定には互換性がない。前者は、モデルとデータの乖離を検討するという考えである、後者は仮説が検証できると盲信し、検証する方法である。}
\footnote{複数回の検定を行うので、多重検定の問題もあり、想定された$\alpha$水準を満たされないことが指摘されている。}
\footnote{仮説検定が廃止されたとしても、過去の研究においては仮説検定が使われており、それら過去の研究を理解する必要がある。この理由から仮説検定を理解しなければならない}。




%\section{仮説検定の手順}
%仮説検定の手順を確認する。
%仮説検定では、仮説の前提が正しいことを決定する必要がある。
%統計モデルがデータと乖離していれば、推定値が何を意味するかが捉えられなくなると考えられており、
%データが前提を満たすように、得られたデータを仮説の前提と一致するように、数学的な変換を施すこともある\footnote{標本分布の形が失われる}。
%科学的仮説検定では、モデルを調整し、再度計測することを要求
%ので、統計モデルの改訂を要求されることもある。
%ただし、$p$値を小さくすることを目標に統計モデルを改訂してはいけない。


\begin{framed}
    \begin{enumerate}
        \item 仮説検定が使える前提が何かを確認する。前提は以下のようになることが多い。
        \begin{quote}
            \begin{itemize}
                \item 確率変数は独立同一分布に従う
                \item 分布関数(正規分布など)
            \end{itemize}
        \end{quote}
        %\item 統計モデルに母数を設定する.経験的に知っている値や、過去の論文や予備実験で明らかになった値である方が良い
        %\item 統計モデルからサンプリングした確率変数の統計量が従う分布関数を探す。統計モデルの性質によって、母集団から得られた標本から得られた統計量の出現確率が計算可能になる。一般の仮説検定は本などでこの分布関数を確認する。
        \item 有意水準$\alpha$を設定する（さまざまな業界で$0.05$が設定される）。
        \item 母集団から無作為抽出を行い、標本を得る
        \item 標本が仮説の前提を満たしていることを確認する。標本分布と仮説の前提の分布関数がある程度一致していることを調べる。正規分布を前提にしているなら、正規分布の検定を行う。
        %\begin{quote}
            %標本が統計モデルにより推測できないと思われる場合、分布関数を変更し、統計モデルを再構築する。

            %または、母集団の性質が別の分布関数になったのだから、仮説検定を使うまでもなく、変化があったことが主張可能である。例えば、正規分布で推測できると(過去の実験や研究結果から)思われてたデータが、実際には指数分布的だった場合など。この場合、計測機器・無作為抽出の方法などに異常がなかったかも確認すべきである。
        %\end{quote}
        \item 標本から統計量を計算し、その値以上に大きな値をとる確率を計算する($p$値)。
        \item $p$値が$\alpha$以下であれば、帰無仮説を棄却し、対立仮説を採択する。
        \item $p$が$\alpha$以上であれば、判断を保留する（最終検定前の検定では採択する）。%\footnote{対立仮説を採択しない流派もあるが、採択していると考えるのが妥当である。}。
    \end{enumerate}
\end{framed}






\if 0


この手順を身長の検証をするためになぞってみます。
\begin{enumerate}
    \item 普段の観察から、身長はある平均値の周りに対象に分布していることがなんとなくわかっているので、対象な分布関数の中から関数を選ぶ。また、サンプルサイズが大きいときの標本を見ると、正規分布でよく推定できることが知られている。以上のことから、正規分布で推測を試みる。
    \item 次の統計モデルを構築する。
    \begin{quote}
        \begin{itemize}
            \item 確率変数は独立同一分布に従う
            \item 正規分布関数
            \item 正規分布関数の母数$\mu,\sigma=5.7$
        \end{itemize}
    \end{quote}
    \item $\mu=170$
    \item 次のことがわかっている$x_1,\cdots,x_n$が正規分布$N(\mu,\sigma^2)$に従う確率変数であるならば、$\frac{\bar{x}-\mu}{\frac{\sigma}{\sqrt{n}}}\sim N(0,1)$である。ここで、$\bar{x}=\frac{x_1+x_2+\cdots+x_n}{n}$
    \item $\alpha=0.05$
    \item 母数からサンプルをランダム抽出し、標本とする。
    \item 無作為抽出できていかたと、標本を正規分布で推測しても良さそうかを検証する
    \item 標本の平均$\bar{X}$を計算し、統計モデルでの出現頻度を計算する。
    \item $p<\alpha$ならば、統計モデルの仮定のうち少なくとも一つがデータと乖離していると考える
    \item 仮説(1),仮説(2)はそれほど悪くない仮説であると思われるので、母数に関する仮定が間違っていると考えられる。以上から、母数は$\mu$ではないと宣言する。
\end{enumerate}

もしも、予備実験から実験状況に変化がなければ、帰無仮説を含んだ統計モデルは棄却されにくい。実験状況に変化があれば、帰無仮説を含んだ統計モデルは棄却されやすくなる。


\fi


\if 0 

このとき、$Z(\bar{x},\mu)$が$N(0,1)$においてよくある値でない場合に、棄却します。
一方で、$Z(\bar{x},\mu)$が$N(0,1)$においてよくある値だったとしても、統計モデルを採用するとは言いません。
また、$Z(\bar,\mu)$の絶対値が$0$よりも十分大きな値を取れば、$N(0,1)$において出にくいということがわかります。これは、$|\bar{X}-\mu|$つまり、統計モデルの母数$\mu$と平均値$\bar{X}$の絶対値が大きければ、$Z(\bar{X},\mu)$の出現頻度は低く、絶対値が十分$0$に近ければ、$Z(\bar{X},\mu)$の出現頻度は高いことを意味します。

ここまでは、全て数学的フィクションである統計モデルの話をしました。では、現実のデータが
では、p値が語っていることを考えるいきます。


以上のことから、この検定を使うには、少なくともQ-Qプロットが必要であることが分かります。


一般に、統計モデルが棄却されない母数の領域を信頼区間といい、棄却される母数の領域を棄却区間という。
特に、$p=0.05$を基準とし、その基準における統計モデルが棄却されない区間を$95\%$ ($100*(1-0.05)$)信頼区間という。


信頼区間と対応する言葉として、採択域(棄却域)というものがある。棄却域は、確率変数を標準正規分布へ変数変換した後での信頼区間である。これは明らかに信頼区間と一対一対応する。

https://twitter.com/genkuroki/status/1270179975195316224


信頼区間は、データによって棄却されない母数の範囲のことである。

信頼区間は、統計モデルが棄却されるパラメータかどうかを表しているので、現実の推論を全く行っていない。

身長を統計モデルにより扱うことで、$p<0.05$では帰無仮説が棄却され、推測を行う統計モデルとはいまいちだということは分かったと思う。一方で、$p>0.05$となった場合でも積極的に採択しないことはなぜだろうか。次は、その理由を探る。
\fi

\if 0
\begin{SMbox}{統計モデルを積極的に採用しない理由}
設定した$\alpha=0.05$よりも大きな$p$値をもつ統計モデル$M(162.2)$は、それなりに推測するでしょうか。この統計モデルにより$P(x=170)$は、極めて少数であり、サンプルサイズを大きくしたときと乖離していることが分かります。このことから、全ての現象に対して特定の$p$値を元に棄却するモデルを決めることの無意味さを感じることができます。
\end{SMbox}
\fi


\if 0    
\begin{SMbox}{帰無仮説のもとで偶然には起こり得ないことが起こった}
    帰無仮説のもとで偶然には起こり得ないことが起こったと言うふうに書くと、現実に起こりにくいと言うふうに印象付けられてしまう。
    非現実である統計モデルの上で、実験で得られた統計量以上の値が得られる確率は十分小さいと言い換えた方が良い。
\end{SMbox}
\fi


\if 0
\begin{SMbox}{正規分布を前提にできる場合}
TODO:意味不明\\
非常に限定された条件で、標本が正規分布していることを前提として使えます。具体的には、標本が分布関数(Cauchy分布は当てはまらない)により生成されていることが前提となる場合です。このとき、中心極限定理によって、十分なサンプルサイズがある場合には、データが正規分布に近づきます。
言い換えれば、サンプルサイズを増やしていけば任意に小さな$p$値を得ることができます。
一方で、一般の現象は特定の分布関数によってデータが生成されているとは言うことはできません。この場合、正規分布に近づくことが正当化できる科学理論はありません。     
\end{SMbox}
\fi


\if 0
\section{一般的な仮説検定の手順}
一般的な仮説検定の手順をまとめる。
%
\begin{framed}
    \begin{itemize}
        \item 帰無仮説($\mu = \mu_0$)・対立仮説($\mu\neq \mu_0$)を設定する。
        \item 仮説が正しいと考えたとき、検定統計量従う分布を考える(4)。
        \item $\alpha$を設定する。
        \item 母集団からの無作為抽出により標本を得る。
        \item 検定統計量を計算し、その出現する確率$p$値を計算する。それが$\alpha$以下であれば、$\mu=\mu_0$ではないと結論づける(帰無仮説が棄却された。)。%ただし、前段階検定においては、$p>\alpha$であれば、帰無仮説を採択する。
    \end{itemize}
\end{framed}
\fi





\begin{comment}
\section{モデルの設定}
仮説検定とモデルに対応付ができるように、仮説の設定をモデルに言い換えて説明する。


帰無仮説$\mu=\mu_0$をを含む統計モデル$M(\mu_0)$を帰無モデル($M_{H_0}$)、対立仮説$\mu\neq \mu_0$を含む統計モデル$M(\mu\neq\mu_0)$を対立モデル($M_{H_1}$)と呼ぶ。
一般に、統計モデルの否定したい母数$\mu_0$を帰無仮説と言い、その母数ではないという$\mu\neq\mu_0$を対立かせつと言う。

具体的には、データがある特定の母数$\mu$をもつ統計モデルの信頼区間に含まれるか否かによって、統計モデルが棄却されるかを調べる。
\begin{itemize}
    \item i.i.d
    \item 数学関数
    \item 統計モデルの母数を$\mu$とし、$\mu=\mu_0$
\end{itemize}
一番最後の仮説が帰無仮説と言う。
対立仮説を含む統計モデル$M_1$は、$M_0$と同様の仮説(1),(2)から構成されまるが、仮説3は統計モデル$M_0$と$M_1$で異なる。
\begin{itemize}
    \item i.i.d
    \item 数学関数
    \item 統計モデルの母数を$\mu$とし、$\mu\neq\mu_0$
\end{itemize}
一番最後の仮説が対立仮説である。$M_1$の最後の仮説は、$M_0$の最後の仮説の否定系である。

二つの統計モデルを作って、$M_0$で計算される信頼区間に、データから得られる統計量が入らないなら、$M_0$は棄却される。
逆に、統計量が信頼区間に入るなら、$M_0$が採択されることはない。
分野によっては採択することがありうる。
このように、否定したい仮説を設定し、少なくとも帰無仮説を含む統計モデルがだめだったと判断する。


 
\end{comment}


\chapter{検定とモデル}
様々な検定が利用されており、それらにおいては何んらかのモデルから導出される統計量に関する性質が利用されている。
ここでは、検定と元々のモデルとの対応関係についてまとめておく。
検定とモデルとで同じ統計的性質を使っているので、まったく同じことを記述することになる。
検定では元のモデルが指定されていないので、何を検証したのかがわからない。
元のモデルが何かを意識できるようにした。

\section{正規モデル}
正規モデル$M_N(\mu,\sigma^2)$について、次が成り立つ。
\paragraph{母分散$\sigma$が不明な場合}
$X_1,X_2,\cdots,X_n \sim N(\mu,\sigma^2)$とする。統計量$T$を、
\begin{equation*}
    T = \frac{\bar{X}-\mu}{\sqrt{\frac{S^2}{n}}}.
\end{equation*}
ここで、$\bar{X}=\frac{X_1+X_2+\cdots+X_n}{n}$、$S^2=\frac{1}{n-1}\sum_{i=1}^{n}(X_i-\bar{X})^2$である。
この統計量$T$は、$t(n-1)$分布に従うことが知られている。
%統計量$T$の中に母数$\sigma$が入っていないので、$\sigma$がわからないときでも、$T$を計算すれば、それが$t(n-1)$に従うことがわかる。


\paragraph{母平均$\mu$が既知の場合}
\begin{theo}\label{normal_sigma_chi2}
    $x_1,x_2,\cdots,x_n,i.i.d. \sim N(\mu,\sigma^2)$について、次が成り立つ。
    \begin{equation*}
     (n-1)\left(\frac{S_x}{\sigma} \right)^2 \sim \chi^2_{n}
    \end{equation*}
    ここで、$S^2_x=\frac{1}{n-1}\sum_{i=1}^n(x_i-\mu)^2$である。
\end{theo}

\paragraph{母平均$\mu$が不明な場合}
分散の変化によって、標本がはずれていることを示す\footnote{分散の検定}。
%母数分散$\sigma$について次が成り立つ。
\begin{theo}\label{normal_sigma_chi2}
    $x_1,x_2,\cdots,x_n,i.i.d. \sim N(\mu,\sigma^2)$について、次が成り立つ。
    \begin{equation*}
        (n-1)\left(\frac{S_x}{\sigma} \right)^2 \sim \chi^2_{n-1}
    \end{equation*}
    ここで、$S^2_x=\frac{1}{n-1}\sum_{i=1}^n(x_i-\bar{x})^2,\bar{x}=\frac{1}{n}\sum_{i=1}^n x_i$である。
\end{theo}

\section{正規2モデル}
\paragraph{検定統計量$T$について}
2つの正規分布$X_1,X_2,\cdots,X_{n_1} \sim N(\mu_1,\sigma_1^2), Y_1,Y_2,\cdots,Y_{n_2}\sim N(\mu_2,\sigma_1^2)$とする。このとき、
\begin{equation*}
    T = \frac{(\bar{X}-\bar{Y})-(\mu_1-\mu_2)}{\sqrt{\frac{U^2}{n_1}+\frac{U^2}{n_2}}}
\end{equation*}
は、$n_1+n_2-2$の$t$分布に従う。ここで、$U$は、
\begin{equation*}
    U^2 = \frac{(n-1)U_1^2+(n_2-1)U_2^2}{n_1-1+n_2-1}
\end{equation*}
であり、$U_1,U_2$は、不偏分散
\begin{eqnarray*}
    U_1^2 = \frac{1}{n_1-1}\sum_{i=1}^{n_1}(X_i-\bar{X})\\
    U_2^2 = \frac{1}{n_2-1}\sum_{i=1}^{n_2}(Y_i-\bar{Y})\\
\end{eqnarray*}
である。


\section{独立性の検定}
% \footnote{検定について次のpdfを参考にした\url{https://www.hiroshima-u.ac.jp/system/files/161890/ASstatistics_2020_2.pdf}}

\subsection{検定}
$k$種類の事象$A_1,A_2,\cdots,A_k$はそれぞれおよそ$p_1,p_2,\cdots,p_k$の割合で出現するとする。このとき、各事象を観測した回数は$n_1,n_2,\cdots,n_k$であった。
観測結果が理論から得られる期待回数と適合することを検討したい。
そこで、帰無仮説$H_0$「期待回数と観測回数は等しい」を検定したい。

\if 0
\fi

\begin{table}[hbtp]
 \caption{2項検定}
 \label{table:binomial_test}
 \centering
 \begin{tabular}{c|cccc|c}
  事象 & $A_1$ & $A_1$ & $\cdots$ & $A_k$ & 計 \\    \hline \hline
  観測回数 & $n_1/m$ & $n_2/m$ & $\cdots$ & $n_k/m$ &  $m=\sum_{i=0}^{k} n_i $ \\
  期待回数 & $N p_1$ & $N p_2$ & $\cdots$ & $N p_k$ &  $N$ 
 \end{tabular}
\end{table}


$H_0$のもと、次の統計量を考える。
\begin{equation*}
 \sum_{i=1}^{k} \frac{(X_i - N p_i)^2}{N p_i}
\end{equation*}


ここで、事象$A_i$が表れる回数を確率変数$X_i$である\footnote{この確率変数がなにに従うのかの記述がないことが多いが、なくてもいいものなのだろうか}。
この統計量は、$N p_i \geq 5 (i=1,2,\cdots, k)$であるとき自由度$k-1$の$\chi^2$分布にしたがう。

このことから、データとの乖離をしらべるには、まず次の統計量を計算する。
\begin{equation*}
 F=\sum_{i=1}^{k} \frac{(n_1/m- N p_i)^2}{N p_i}
\end{equation*}
そして、$F \geq \chi^2_{k-1}(\alpha)$ならば$H_0$を棄却する。


さて、これはどのようなモデルから導出された統計量とデータを比較しているのだろうか。
確率変数$X_i$はどのような分布に従っているのかわかるだろうか\footnote{以上のような記述では、分布系がわからない。}。

\subsection{モデル}
モデルを構築する。
\begin{enumerate}
 \item $Z_i \sim B(n,p_i) (i=0,1,\cdots,k) $ここで、$B(n,p_i)$は二項分布。
\end{enumerate}
このモデルを$M_B$とする。このとき、次の統計量$X_2$を定義する。
\begin{equation*}
 X_2 = \sum_{i=0}^{k} \frac{Z_i-n p_i}{n p_i}
\end{equation*}


$X_2$は、$n\rightarrow \infty$のとき、自由度$(k-1)$の$\chi^2$分布に従う。ただし、$n\rightarrow \infty$ではなく$n p_i geq 5 (i=0,1,\cdots,k))$で十分である\cite{1050850569142531968}。
適合度検定をおこなうということは、モデル$M_B$から演繹的に導出される$X_2$の性質とデータとを比較するということである。
$p$値が小ければ$M_B$で推測することは止めておいたほうがよさそうかもしれないと考え、このモデルとデータをさらに詳しく調べる必要がある。

このモデル$M_B$において、尤度比に関する統計量をつかうこともできる。





\section{独立性の検定}
ある事象$A,B$はそれぞれ$k,c$個に分類され、その事象を$A_1,A_2,\cdots,A_k$および$B_1,B_2,\cdots,B_c$とする。
このとき、事象の組$(A_i,B_j)$が、得られた回数を$n_{i,j}$とする。
例えば、$n$人の成人を無作意に選び、その人のパートナーの有無を$A$とし、パートナーがいるを$A_1$いないを$A_2$とする。
また、対象者の年収を$B$とし、$100$万から$200$万を$B_1$、$200$万から$300$万を$B_2$などとする。
パートナーがいて、年収が$100$万から$200$万の人が$100$人いれば、$n_{1,1}=100$である。
また、パートナーがいて、年収が$200$万から$300$万の人が$1000$人いれば、$n_{1,1}=1000$である。

これを表にまとめると、次の様になる。
\begin{table}[hbtp]
 \caption{2項検定}
 \label{table:binomial_test2}
 \centering
\begin{tabular}{c|cccc|c}
 事象& $A_1$ & $A_2$ & $\cdots$ & $A_k$ & 計 \\ \hline
 $B_1$ & $n_{1,1}$ & $n_{1,2}$ & $\cdots$ & $n_{1,k}$ &$n_1^*$ \\ 
 $B_2$ & $n_{2,1}$ & $n_{2,2}$ & $\cdots$ & $n_{2,k}$ &  $n_2^*$ \\
 & & & & & \\
 $B_c$ & $n_{c,1}$ & $n_{c,2}$ & $\cdots$ & $n_{c,k}$ &  $n_c^*$ \\ 
       & $n_*^1$ & $n_*^2$     & $\cdots$ & $n_*^k $  & $n$
\end{tabular}
\end{table}
ここで、$n_j^* = \sum_{i=1}^k n_{j,i} (j=1,2,\cdots,k), n_*^j = \sum_{i=1}^c n_{i,j} (j=1,2,\cdots,c), n = \sum_{j=1}^k n_j^*+ \sum_{j=1}^c n_*^j$である。



\subsection{検定}


\subsection{モデル}
モデル$M_B$を構築する。
\begin{enumerate}
 \item $X_{i} \sim B(n,p_i)$
 \item $Y_{i} \sim B(n,q_i)$
 \item ( $X_{i,j} \sim B(n, p_i q_j)  (i=1,2,\cdots,k, j=1,2,\cdots,c))$)
\end{enumerate}
以上の仮定は確率変数はそれぞれ独立した２項分布に従うことを意味する。

このモデルにおいて、次の検定統計量$Q(X)$に関する性質を得る。

\begin{equation*}
 Q(X) = \sum^k \sum^c \frac{ X_{i,j} - \frac{p_i q_j}{n}}{\frac{p_i q_j}{n} }
\end{equation*}
これは、漸近的に自由度$(k-1)(c-1)$の$\chi^2$分布に従うことが知られる。

上記のデータであれば、次の$Q$を計算する。
\begin{equation*}
 Q = \sum_i^k \sum_j^c \frac{ n_{i,j} - n\frac{n_i^* n_*^j}{n^2}}{n\frac{n_i^* n_*^j}{n^2} }
\end{equation*}




\subsection{計算例}
実際の例をみる。

\begin{table}[hbtp]
 \caption{2項検定}
 %\label{table:binomial_test2}
 %\centering
\begin{tabular}{c|cc|c}
 & 治った患者 & 治らなかった患者 & 合計 \\
 新薬を投与された患者&45 & 15& 60  \\
 偽薬を投与された患者&20 & 20 & 40 \\
 合計 & 65& 35& 100
\end{tabular}
\end{table}

次のモデル$M_B$を構築する。
\begin{enumerate}
 \item $X_{i,j} \sim B(n,p_i q_j) (i=1,2,j=1,2)$
 \item 母数$p_i,q_j$は不明
\end{enumerate}
このデータとの乖離を検定統計量$Q$を計算することで確かめてみる。
\begin{eqnarray*}
 Q &=& \frac{(45-60*20/100)^2}{60*20/100} +\frac{(15-60*35/100)^2}{60*35/100} + \\
&&\frac{(20-40*65/100)^2}{40*65/100} + 
\frac{(20-40*35/100)^2}{40*35/100} \\
&=& 6.5934
\end{eqnarray*}
これは、自由度$1$の$\chi^2(0.05)$は、$3.84$である。$\chi^2(0.01)=6.64$程度なので、モデル$M_B$では珍しい値である気分になってくる。
それぞれが独立にきまるモデル、モデル$M_B$による推測はやめておいたほうがよさそうである。
この解析だけでは他の良いモデルがあることは示されていない\footnote{別のモデルが良いとは言い切れない}。

\begin{comment}
 = (45-60*65/100)^2/(60*65/100)+(15-60*35/100)^2/(60*35/100)+(20-40*65/100)^2/(40*65/100) + (20-40*35/100)^2/(40*35/100)
 = 6.5934
\end{comment}



%https://ds.machijun.net/clear-exercise-of-statistics/%E7%AC%AC7%E7%AB%A0-%E6%8C%87%E6%95%B0%E6%AF%8D%E9%9B%86%E5%9B%A3ex%CE%BC%EF%BC%89%E3%81%AE%E6%AF%8D%E5%B9%B3%E5%9D%87%E3%81%AE%E4%BF%A1%E9%A0%BC%E5%8C%BA%E9%96%93%E3%81%A8%E6%A4%9C%E5%AE%9Ap128/
\section{指数分布を含むモデル}

\begin{theo}
    $x_1,x_2,\cdots,x_n,i.i.d. \sim \rm{Exp}(\lambda)$とする。
    このとき$x_1+x_2+\cdots+x_n \sim Ga(n,\lambda)$である。
\end{theo}

$n$を自然数とし、ガンマ分布$Ga(\frac{n}{2},2)$をカイ２乗分布といい、$\chi ^2_n$で表す。

\begin{theo}
$n$を自然数とする。$G\sim Ga(\frac{n}{2},\beta),Y_n\sim \chi^2_n$とすると、$P(G\leq w) = P(Y_n \leq 2\beta w)$
\end{theo}
\begin{proof}
$w >0$に対して、
\begin{eqnarray*}
    P(G \leq w) &=& \int_0^w \frac{\beta^\frac{n}{2}}{\Gamma(n/2)}x^{n/2-1}\exp{(-\beta x)}dx \\
    &=&\int_0^{2\beta w} \frac{\beta^{\frac{n}{2}}}{\Gamma(n/2)}\left( \frac{t}{2\beta} \right)^{n/2-1}\exp{(-\beta t/2\beta)}\frac{dt}{2\beta} (x=t/(2\beta)) \\
    &=& \int_0^{2\beta w} \frac{1}{2^{n/2}\Gamma(n/2)}t^{n/2-1}\exp{(-t/2)}dt\\
    &=&P(Y_n \leq 2\beta w)
\end{eqnarray*}
\end{proof}

以上より$n\bar{x}\sim \Gamma(n,\lambda)$である。
このとき、$\lambda$の信頼区間を求める。$\lambda$の下限は、
\begin{equation}
    P(G\leq n\bar{x}) = \frac{\alpha}{2}
\end{equation}
を満たし、$\lambda$の上限は、
\begin{equation}
P(G\leq n\bar{x}) = 1-\frac{\alpha}{2}
\end{equation}
を満たす。
下限の式を変形していく。
\begin{eqnarray*}
    \alpha/2 &=& P(G\leq n\bar{x})  \\
    &=& P(Y_{2n}\leq 2n \lambda_l \bar{x})\\
    &\rightarrow& 2n\lambda \bar{x} = \chi^2_{2n}(1-\alpha/2)\\
    &\rightarrow& \lambda = \frac{\chi^2_{2n}(1-\alpha/2)}{2n\bar{x}}
\end{eqnarray*}
上限についても同様に、
\begin{eqnarray*}
    1-\frac{\alpha}{2} &= & P(G\leq n\bar{x}) \\
    &=& P(Y_{2n}\leq 2n\lambda \bar{x})  \\
    &\rightarrow& 2n\lambda \bar{x} = \chi^2_{2n}(\alpha/2)\\
    &\rightarrow&  \lambda = \frac{\chi^2_{2n}(\alpha/2)}{2n\bar{x}}
\end{eqnarray*}
以上によって、$\frac{1}{\lambda}$の信頼区間は、
\begin{equation}
    \label{exp_model_confidence_interval}
    \frac{2n\bar{x}}{\chi^2_{2n}(\alpha/2)} \leq \bar{x} \leq \frac{2n\bar{x}}{\chi^2_{2n}(1-\alpha/2)}
\end{equation}




\section{指数2モデル}
指数分布を含んだモデルを構築する。
\begin{enumerate}
 \item $x_1,x_2,\cdots,x_n,i.i.d. \sim \rm{Exp}(\theta_1)$
 \item $y_1,y_2,\cdots,y_n,i.i.d. \sim \rm{Exp}(\theta_2)$
\end{enumerate}
これを、$M_E(\theta_1,\theta_2)$とする。$\theta_1=\theta_2$のモデルを$M_N(\theta)$とする。
\paragraph{$M_N(\theta)$における尤度関数}
$M_N(\theta)$において、この尤度関数を計算する。
\begin{equation*}
 L_{0} = \theta^{-n_1-n_2}\exp\{-\theta^{-1}T\}
\end{equation*}
ただし、$T=\sum_{i=0}^n x_i+\sum_{i=0}^n y_i$である。尤度が最大$\frac{\partial L_1}{\partial\theta}=0$となる$\theta$を計算する。
\begin{equation}
    \frac{\partial L_0}{\partial\theta} = \{ -(n_1+n_2)+\theta^{-1}T \}\theta^{-n_1-n_2-1}\exp(-\theta^{-1}T).
\end{equation}
より、$\theta_0=\frac{T}{n_1+n_2}$である。
$\theta_0$を$L_{0}$に代入すると、
\begin{equation}
    L_{0} = \theta_0^{-n_1-n_2}\exp(-n_1-n_2).
\end{equation}
である。

\paragraph{$M_N(\theta_1,\theta_2)$における尤度関数}
同様に、対立仮説のもとで、尤度関数$L_{1}$は、
\begin{equation}
    L_{1} = \theta_1^{-n_1}\exp\left(-\frac{n_1}{\theta_1}\bar{x}\right)\theta_2^{-n_2}\exp\left(-\frac{n_2}{\theta_2}\bar{y}\right)
\end{equation}
$\frac{\partial L_1}{\partial\theta}=0$となる$\theta_1$を計算する。
\begin{equation}
    \frac{\partial L_1}{\partial\theta_1}=\left( -n_1\theta_1^{-n_1-1} \exp\left(-\frac{n_1}{\theta_1}\bar{x}\right)+n_1\bar{x}\theta_1^{-n_1-2}\exp\left(-\frac{n_1}{\theta_1}\bar{x}\right)\right)\theta_2^{-n_2}\exp\left(-\frac{n_2}{\theta_2}\bar{y}\right).
\end{equation}
$ \frac{\partial L_1}{\partial\theta_1}=0$より、$(-n_1+n_1\bar{x}\theta_1^{-1})\theta_1^{-n_1-1}=0$より、$\hat{\theta}_1=\bar{x}$である。同様に、$\hat{\theta}_2=\bar{y}$。
以上によって、$L_{1}$は、
\begin{equation}
    L_{1}(\hat{\theta}_1,\hat{\theta}_2) = (\hat{\theta}_1)^{-n_1}\exp(-n_1)(\hat{\theta_2})^{-n_2}\exp(-n_2)
\end{equation}
である。

\paragraph{尤度比}
\begin{eqnarray}
    \varLambda = \frac{L_{0}}{L_{1}} &=& \frac{ \theta_0^{-n_1-n_2}\exp(-n_2-n_2) }{ (\hat{\theta}_1)^{-n_1}(\hat{\theta}_2)^{-n_2} \exp(-n_1-n_2)}\\
    &=& \left(\frac{\hat{\theta_0}}{\theta_0}\right)^{n_1} \left(\frac{\hat{\theta_1}}{\theta_0} \right)^{n_2}
\end{eqnarray}
尤度比検定より、$-2\log \varLambda \sim\chi^2_1$である\footnote{いくらか条件がある}。

